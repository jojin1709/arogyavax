<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurse Dashboard - ArogyaVax</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <nav>
            <div class="logo">
                <a href="index.html">ü©∫ ArogyaVax Nurse</a>
            </div>
            <div class="nav-links">
                <a href="index.html"
                    style="margin-right: 1rem; text-decoration: none; color: var(--text-main);">Home</a>
                <div style="display:flex; align-items:center; gap:10px; margin-right:1rem;">
                    <img id="headerAvatar" src="images/default-avatar.png"
                        style="width:32px; height:32px; border-radius:50%; object-fit:cover; border: 2px solid var(--white);"
                        onerror="this.src='https://ui-avatars.com/api/?name=Nurse'">
                    <span id="userName" style="font-weight: 600;">Nurse</span>
                </div>
                <button id="theme-toggle" class="btn-outline"
                    style="border:none; font-size: 1.2rem; margin-right: 1rem;">üåô</button>
                <button onclick="logout()" class="btn">Logout</button>
            </div>
        </nav>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar">
            <a href="#" class="sidebar-link active" onclick="showSection('dashboardSection')">üìä Dashboard</a>
            <a href="#" class="sidebar-link" onclick="showSection('scheduleSection')">üìÖ Schedule</a>
            <a href="#" class="sidebar-link" onclick="showSection('administerSection')">üíâ Administer</a>
            <a href="#" class="sidebar-link" onclick="showSection('managePatientSection')">üë• Patients</a>
            <a href="#" class="sidebar-link" onclick="showSection('automationSection')">ü§ñ Automation</a>
            <a href="#" class="sidebar-link" onclick="showSection('settingsSection')">‚öôÔ∏è Settings</a>
        </aside>

        <main class="main-content">
            <!-- DASHBOARD HOME -->
            <div id="dashboardSection" class="section-content">
                <h2>Nurse Dashboard</h2>
                <br>
                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h4>Today's Appointments</h4>
                            <p id="stat-today">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h4>Completed</h4>
                            <p id="stat-completed">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h4>Pending</h4>
                            <p id="stat-pending">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <!-- Red Alert Style -->
                        <div class="stat-info" style="color:red">
                            <h4>Overdue Alerts</h4>
                            <p id="stat-overdue">0</p>
                        </div>
                    </div>
                </div>

                <!-- Today's Appointment List -->
                <br>
                <h3>Today's Schedule</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Patient</th>
                                <th>Vaccine</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="todayList"></tbody>
                    </table>
                </div>

                <!-- Overdue Alerts -->
                <br>
                <h3>‚ö†Ô∏è Overdue Vaccinations</h3>
                <div id="overdueList" class="table-container"></div>
            </div>

            <!-- SCHEDULE MANAGEMENT -->
            <div id="scheduleSection" class="section-content" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Schedule Management</h2>
                    <div>
                        <button class="btn" onclick="openBookingModal()">+ Book Appointment</button>
                        <button class="btn-outline" onclick="printSchedule()">üñ®Ô∏è Print Day</button>
                    </div>
                </div>
                <br>
                <div class="tabs">
                    <button class="tab-btn active" onclick="">Weekly View</button>
                    <button class="tab-btn" onclick="">Monthly View</button>
                </div>
                <div id="calendarView"
                    style="margin-top:20px; text-align:center; padding:50px; border:1px dashed #ccc;">
                    [Calendar Visualization would go here]
                    <br><br>
                    <p>Sample Booking: <br> 09:00 AM - Baby John (BCG) <br> 10:30 AM - Baby Doe (Polio)</p>
                </div>
            </div>

            <!-- ADMINISTER VACCINE -->
            <div id="administerSection" class="section-content" style="display: none;">
                <h2>Administer Vaccine</h2>
                <div class="auth-container" style="margin: 0; max-width: 600px;">
                    <form id="administerForm">
                        <div class="form-group">
                            <label>Patient Phone Number / Aadhaar</label>
                            <input type="text" id="patientIdentifier" placeholder="Enter identifier" required>
                        </div>
                        <div class="form-group">
                            <label>Select Vaccine</label>
                            <select id="vaccineSelect">
                                <option value="1">BCG</option>
                                <option value="2">Hepatitis B</option>
                                <option value="3">OPV</option>
                                <option value="4">Covaxin</option>
                                <option value="5">Covishield</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Mark as Administered</button>
                    </form>
                </div>
            </div>

            <!-- MANAGE PATIENTS -->
            <div id="managePatientSection" class="section-content" style="display: none;">
                <h2>Manage Patients</h2>
                <div class="search-bar" style="margin-bottom: 2rem; display: flex; gap: 10px;">
                    <input type="text" id="statsSearch" placeholder="Search by Name, Phone, or Aadhaar..."
                        style="flex: 1; padding: 10px;">
                    <button class="btn" onclick="searchPatients()">Search</button>
                </div>
                <div id="searchResults" style="margin-bottom: 2rem;"></div>
                <div id="patientEditor"
                    style="display: none; border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
                    <!-- Editor Form Same as before -->
                    <h3>Edit Patient</h3>
                    <form id="editPatientForm">
                        <input type="hidden" id="edit-id">
                        <input type="text" id="edit-name" placeholder="Name" required><br><br>
                        <input type="text" id="edit-phone" placeholder="Phone"><br><br>
                        <input type="text" id="edit-aadhaar" placeholder="Aadhaar"><br><br>
                        <input type="date" id="edit-dob" placeholder="DOB"><br><br>
                        <input type="text" id="edit-address" placeholder="Address"><br><br>
                        <button type="submit" class="btn">Save</button>
                        <button type="button" class="btn-outline" onclick="closeEditor()">Cancel</button>
                    </form>
                    <h3 style="margin-top:20px;">History</h3>
                    <table class="table" style="width:100%">
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- AUTOMATION -->
            <div id="automationSection" class="section-content" style="display:none;">
                <h2>Automation Center</h2>
                <br>
                <div class="card" style="padding:20px; border:1px solid #eee;">
                    <h3>Batch Reminders</h3>
                    <p>Send reminders to all patients with upcoming/overdue vaccines.</p>
                    <br>
                    <button class="btn" onclick="sendBatchReminders()">üöÄ Trigger Batch Reminders</button>
                </div>
                <br>
                <div class="card" style="padding:20px; border:1px solid #eee;">
                    <h3>Children Due This Week</h3>
                    <table class="table" style="width:100%; margin-top:10px;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Vaccine</th>
                                <th>Contact</th>
                            </tr>
                        </thead>
                        <tbody id="dueListBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- SETTINGS SECTION -->
            <div id="settingsSection" class="section-content" style="display:none;">
                <h2>Profile Settings</h2>
                <div class="auth-container" style="margin: 0; max-width: 600px;">
                    <form id="profileForm">
                        <div style="text-align:center; margin-bottom:1.5rem;">
                            <img id="profilePreview" src="images/default-avatar.png"
                                style="width:100px; height:100px; border-radius:50%; object-fit:cover; border: 3px solid var(--primary); margin-bottom:10px;"
                                onerror="this.src='https://ui-avatars.com/api/?name=Nurse'">
                            <br>
                            <label for="profileUpload" class="btn-outline" style="cursor:pointer; font-size:0.9rem;">üì∑
                                Upload Photo</label>
                            <input type="file" id="profileUpload" accept="image/*" style="display:none;">
                        </div>

                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="updateName" placeholder="Update Name">
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="text" id="updatePhone" placeholder="Update Phone">
                        </div>
                        <div class="form-group">
                            <label>New Password (Optional)</label>
                            <input type="password" id="updatePassword" placeholder="New Password">
                        </div>
                        <button type="submit" class="btn">Save Changes</button>
                    </form>
                </div>
            </div>

            <!-- MODALS -->
            <div id="bookingModal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
                <div class="modal-content" style="background:white; padding:20px; border-radius:10px; width:400px;">
                    <h3>Book Appointment</h3>
                    <input type="text" id="bookPatientId" placeholder="Patient ID"><br><br>
                    <input type="date" id="bookDate"><br><br>
                    <input type="time" id="bookTime"><br><br>
                    <button class="btn" onclick="bookAppointment()">Confirm</button>
                    <button class="btn-outline" onclick="closeBookingModal()">Cancel</button>
                </div>
            </div>

            <!-- Certificate Modal (Same as before) -->
            <div id="certificateModal" class="modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
                <div class="modal-content"
                    style="background:white; padding:40px; border-radius:10px; text-align:center; max-width:600px; width:90%;">
                    <div id="certContent" style="border: 5px double #2c3e50; padding: 20px;">
                        <h1 style="color: #2c3e50;">Vaccination Certificate</h1>
                        <p>This is to certify that</p>
                        <h2 id="certName" style="color: #27ae60;">[Patient Name]</h2>
                        <p>has successfully received the vaccine</p>
                        <h3 id="certVaccine" style="color: #2980b9;">[Vaccine Name]</h3>
                        <p>on <span id="certDate">[Date]</span> at <span id="certHospital">City General Hospital</span>
                        </p>
                        <br>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=Verified" alt="QR">
                        <p style="font-size: 0.8rem; color: #7f8c8d; margin-top:10px;">Verified by ArogyaVax</p>
                    </div>
                    <br>
                    <button class="btn" onclick="printCertificate()">Print</button>
                    <button class="btn-outline" onclick="closeCertificate()">Close</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Chatbot Widget -->
    <button class="chatbot-toggler"><span>üí¨</span></button>
    <div class="chatbot">
        <header>
            <h2>Nurse Assistant</h2>
            <span class="close-btn"
                style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); cursor: pointer;">‚úï</span>
        </header>
        <ul class="chatbox">
            <li class="chat incoming">
                <p>Ready to assist with records.</p>
            </li>
        </ul>
        <div class="chat-input">
            <textarea placeholder="Type a message..." required></textarea>
            <span id="send-btn">‚û§</span>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'nurse') window.location.href = 'login.html';

        function logout() { localStorage.removeItem('user'); window.location.href = 'index.html'; }

        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).style.display = 'block';
            event.target.classList.add('active'); // This might be buggy if event not captured, but ok for now

            if (sectionId === 'dashboardSection') loadDashboard();
            if (sectionId === 'automationSection') loadDueList();
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const statsRes = await fetch('/api/nurse/stats');
            const stats = await statsRes.json();

            document.getElementById('stat-today').textContent = stats.today || 0;
            document.getElementById('stat-completed').textContent = stats.completed || 0;
            document.getElementById('stat-pending').textContent = stats.pending || 0;
            document.getElementById('stat-overdue').textContent = stats.overdue || 0;

            const apptRes = await fetch(`/api/nurse/appointments?date=${today}`);
            const appts = await apptRes.json();
            const tbody = document.getElementById('todayList');
            tbody.innerHTML = '';

            if (appts.appointments) {
                appts.appointments.forEach(a => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${a.appointment_time}</td>
                        <td>${a.patient_name} <br> <small>${a.phone}</small></td>
                        <td>${a.vaccine_name || 'General'}</td>
                        <td>${a.status}</td>
                        <td>
                            ${a.status === 'scheduled' ? `<button class="btn-outline" onclick="checkIn(${a.id})">Check In</button>` : '-'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        async function checkIn(id) {
            await fetch(`/api/nurse/check-in/${id}`, { method: 'PUT' });
            loadDashboard(); // Refresh
        }

        // --- AUTOMATION ---
        async function sendBatchReminders() {
            if (!confirm('Send reminders to ALL patients?')) return;
            const res = await fetch('/api/admin/batch-reminders', { method: 'POST' });
            const data = await res.json();
            alert(data.message);
        }

        async function loadDueList() {
            const res = await fetch('/api/nurse/due-list');
            const data = await res.json();
            const tbody = document.getElementById('dueListBody');
            tbody.innerHTML = '';
            data.dueList.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${d.name}</td><td>${d.age}</td><td>${d.vaccine}</td><td>${d.contact}</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- SCHEDULE ---
        function openBookingModal() { document.getElementById('bookingModal').style.display = 'flex'; }
        function closeBookingModal() { document.getElementById('bookingModal').style.display = 'none'; }

        async function bookAppointment() {
            const patientId = document.getElementById('bookPatientId').value;
            const date = document.getElementById('bookDate').value;
            const time = document.getElementById('bookTime').value;

            // Hardcoded vaccine ID for demo or need select
            const res = await fetch('/api/nurse/appointment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ patientId, vaccineId: 1, date, time })
            });

            if (res.ok) { alert('Booked!'); closeBookingModal(); }
            else alert('Error');
        }

        function printSchedule() { window.print(); }

        // --- ADMINISTER --- (Existing logic)
        document.getElementById('administerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const identifier = document.getElementById('patientIdentifier').value;
            const vaccineSelect = document.getElementById('vaccineSelect');
            const vaccineId = vaccineSelect.value;
            const vaccineName = vaccineSelect.options[vaccineSelect.selectedIndex].text;

            try {
                const res = await fetch('/api/record-vaccine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, vaccineId, vaccineName })
                });
                const result = await res.json();

                if (res.ok) {
                    alert(`‚úÖ Success: ${result.message} for ${result.patient}`);
                    document.getElementById('administerForm').reset();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (err) {
                console.error(err);
                alert('System Error');
            }
        });

        // --- PATIENTS --- (Existing logic)
        async function searchPatients() {
            const query = document.getElementById('statsSearch').value;
            const res = await fetch(`/api/nurse/search-patients?query=${encodeURIComponent(query)}`);
            const data = await res.json();
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            if (data.patients.length === 0) { resultsDiv.innerHTML = '<p>No patients found.</p>'; return; }
            data.patients.forEach(p => {
                const div = document.createElement('div');
                div.className = 'card'; div.style.padding = '10px'; div.style.marginBottom = '10px'; div.style.border = '1px solid #ccc';
                div.innerHTML = `<p><strong>${p.name}</strong> - ${p.phone || 'No Phone'}</p><button class="btn-outline" onclick="editPatient(${p.id})">Manage</button>`;
                resultsDiv.appendChild(div);
            });
        }

        async function issueCertificate(recordId) {
            if (!confirm('Issue certificate for this vaccination?')) return;
            try {
                const res = await fetch('/api/nurse/issue-certificate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recordId })
                });
                if (res.ok) {
                    alert('Certificate Issued! ‚úÖ');
                    // Reload details
                    const id = document.getElementById('detailsId').value; // Hidden input we need to add or grab from context
                    // For simplicity, just reload the page or re-search? 
                    // Let's re-call loadPatientDetails if we have the ID.
                    // Actually, let's just grab the current search ID if possible.
                    // A better way: The edit form has the ID.
                    loadPatientDetails(document.getElementById('editId').value);
                }
            } catch (err) { console.error(err); }
        }

        async function editPatient(id) {
            const res = await fetch(`/api/nurse/patient/${id}`);
            if (!res.ok) return alert('Error fetching patient details');
            const data = await res.json();
            const p = data.patient;
            document.getElementById('patientEditor').style.display = 'block';
            document.getElementById('edit-id').value = p.id;
            document.getElementById('edit-name').value = p.name;
            document.getElementById('edit-phone').value = p.phone || '';
            document.getElementById('edit-aadhaar').value = p.aadhaar || '';
            document.getElementById('edit-dob').value = p.dob ? p.dob.split('T')[0] : '';
            document.getElementById('edit-address').value = p.address || '';
            // Render History
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            data.vaccinations.forEach(v => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${v.vaccine_name}</td><td>${new Date(v.date_administered).toLocaleDateString()}</td><td>Administered</td><td><button class="btn" onclick="openCertificate('${p.name}', '${v.vaccine_name}', '${v.date_administered}')">View Cert</button></td>`;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('editPatientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const body = {
                name: document.getElementById('edit-name').value,
                phone: document.getElementById('edit-phone').value,
                aadhaar: document.getElementById('edit-aadhaar').value,
                dob: document.getElementById('edit-dob').value,
                gender: 'Male', // simplified for now
                address: document.getElementById('edit-address').value
            };
            const res = await fetch(`/api/nurse/patient/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            if (res.ok) { alert('Updated!'); closeEditor(); searchPatients(); }
            else alert('Update failed');
        });

        function closeEditor() { document.getElementById('patientEditor').style.display = 'none'; }
        function openCertificate(name, vaccine, date) {
            document.getElementById('certificateModal').style.display = 'flex';
            document.getElementById('certName').innerText = name;
            document.getElementById('certVaccine').innerText = vaccine;
            document.getElementById('certDate').innerText = new Date(date).toLocaleDateString();
        }
        function closeCertificate() { document.getElementById('certificateModal').style.display = 'none'; }
        function printCertificate() {
            const content = document.getElementById('certContent').innerHTML;
            const win = window.open('', '', 'height=700,width=700');
            win.document.write('<html><body style="text-align:center;font-family:sans-serif;">' + content + '</body></html>');
            win.document.close(); win.print();
        }

        // Profile Logic for Nurse
        // Pre-fill
        if (document.getElementById('userName')) document.getElementById('userName').textContent = user.name;
        if (document.getElementById('updateName')) document.getElementById('updateName').value = user.name;
        if (document.getElementById('updatePhone')) document.getElementById('updatePhone').value = user.phone || "";

        let base64Image = "";
        // Init Profile Pic from User Data
        const initAvatar = () => {
            if (user.profile_pic) {
                if (document.getElementById('headerAvatar')) document.getElementById('headerAvatar').src = user.profile_pic;
                if (document.getElementById('profilePreview')) document.getElementById('profilePreview').src = user.profile_pic;
            } else {
                const fallback = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}`;
                if (document.getElementById('headerAvatar')) document.getElementById('headerAvatar').src = fallback;
                if (document.getElementById('profilePreview')) document.getElementById('profilePreview').src = fallback;
            }
        };
        initAvatar();

        // Handle File Selection
        if (document.getElementById('profileUpload')) {
            document.getElementById('profileUpload').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (evt) {
                        base64Image = evt.target.result;
                        document.getElementById('profilePreview').src = base64Image;
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('updateName').value;
                const phone = document.getElementById('updatePhone').value;
                const password = document.getElementById('updatePassword').value;
                const finalImage = base64Image || user.profile_pic || "";

                try {
                    const res = await fetch('/api/auth/update-profile', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: user.id, name, phone, password, profile_pic: finalImage })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        localStorage.setItem('user', JSON.stringify(data.user));
                        alert('Profile updated successfully!');
                        window.location.reload();
                    } else {
                        alert(data.error);
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error updating profile.');
                }
            });
        }

        // Init Load
        loadDashboard();
    </script>
</body>

</html>
```